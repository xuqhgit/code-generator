<form class="form-horizontal" id="inputForm">
    <div class="form-group ">
        <label class="col-sm-2 control-label" for="formGroupInputLarge">选择数据库</label>
        <div class="col-sm-3">
            <select class="form-control" id="databaseSelect" onchange="changeDatabase(this)"></select>
        </div>
        <label class="col-sm-1 control-label" >工号</label>
        <div class="col-sm-2">
            <input type="text" class="form-control" id="account" >
        </div>
        <label class="col-sm-2 control-label" >表名前缀</label>
        <div class="col-sm-2">
            <input type="text" class="form-control" value="{{ ctx.configMap.project.table_prefix }}" id="tablePrefix" >
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label" >选择表</label>
        <div class="col-sm-4">
            <select class="selectpicker show-tick form-control" multiple data-live-search="true"
                    id="tableSelect"></select>
        </div>
        <label class="col-sm-2 control-label" >表名前缀</label>
        <div class="col-sm-4">
            <input type="text" class="form-control" value="{{ ctx.configMap.project.base_package }}" id="basePackage" >
        </div>

    </div>
    <div class="form-group ">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>表名</th>
                <th>类名</th>
                <th>表别名</th>
                <th>模块</th>
                <th>描述</th>
                <th>
                    <a href="javascript:void(0)" onclick="addTr(this)" class="glyphicon glyphicon-plus-sign"></a>
                </th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</form>
<script>
    $('#tableSelect').selectpicker({});
    $.post("/db/getDatabase", {code: "{{ ctx.code }}"}, function (data) {
        var str = "";
        data.forEach(function (e, i) {
            if (i == 0) {
                loadTable(e.Database)
            }
            str += "<option value='" + e.Database + "'>" + e.Database + "</option>"
        })
        $('#databaseSelect').html(str);

    }, "json");


    function loadTable(database) {
        $('#tableSelect').empty();
        $.post("/db/getTables/" + database, {code: "{{ ctx.code }}"}, function (data) {
            var str = "";
            data.forEach(function (e, i) {
                str += "<option text='" + e.tableComment + "' value='" + e.tableName + "'>" + e.tableName + "</option>"
            });
            $('#tableSelect').html(str);

            $('#tableSelect').selectpicker('refresh');
        }, "json");

    }
    function changeDatabase(obj) {
        loadTable($(obj).val())
    }

    $('#tableSelect').on('changed.bs.select', function (obj, clickedIndex, isSelected, previousValue) {
            var valArr = $('#tableSelect').selectpicker('val');
            var arr=[];
            var database = $("#databaseSelect").val();
            valArr.forEach(function (e,i) {

                var $t = $('#table_'+e);
                if($t.size()==0){
                    var text = $("#tableSelect").find("option[value="+e+"]").attr("text");
                   arr.push({"tableName":e,"database":database,"tableAlias":"t","tableComment":text})
                }
            });

            var html = template('j_tr', arr);
            $('#inputForm tbody').append(html);

    });

    function removeTr(ele) {
        console.info($(ele).parents("tr"))
        $(ele).parents("tr").remove();
    }
    function addTr() {
        var html = template('j_tr', [{}]);
        $('#inputForm tbody').append(html);
    }
    function getInputData(){
        var trs = $('#inputForm tbody tr');
        var trsVals = []
        for(var i=0;i<trs.length;i++){
            var inputs = $(trs[i]).find("input");
            var vals = {}
            $.each(inputs,function(){
                vals[$(this).attr("name")] = $(this).val()
            });
            trsVals.push(vals);
        }
        return trsVals;
    }
</script>
<script type="text/html" id="j_tr">
    {[each $data]}
    <tr id="table_{[$value.tableName]}">
        <td>
            <input class="form-control" type="text" name="tableName" value="{[$value.tableName]}">
            <input class="form-control" type="hidden" name="database" value="{[$value.database]}">
        </td>
        <td><input class="form-control" type="text" name="className"></td>
        <td><input type="text" class="form-control"  name="tableAlias" value="{[$value.tableAlias]}"></td>
        <td><input type="text" class="form-control"  name="module"></td>
        <td><input class="form-control" type="text" name="description" value="{[$value.tableComment]}">
        </td>
        <td> <a href="javascript:void(0)" onclick="removeTr(this)" class="glyphicon glyphicon-minus-sign"></a></td>
    </tr>
    {[/each]}
</script>
